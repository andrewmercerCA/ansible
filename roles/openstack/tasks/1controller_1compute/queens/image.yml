--- # https://docs.openstack.org/glance/queens/install/

- name: glance
  block:
    - name: "{{ ansible_distribution }}: create glance database"
      mysql_db:
        name: glance
        state: present
        login_unix_socket: /var/lib/mysql/mysql.sock
    
    - name: "{{ ansible_distribution }}: create glance user"
      mysql_user:
        name: glance
        password: "{{ the_password }}"
        priv: 'glance.*:ALL'
        state: present
        login_unix_socket: /var/lib/mysql/mysql.sock

    - name: "{{ ansible_distribution }}: create the glance openstack user"
      os_user:
        domain: default
        enabled: yes
        name: glance
        password: "{{ the_password }}"
        state: present

  when:
    - ( 'controller' in ansible_hostname )
    - ansible_facts['distribution'] == 'CentOS'

#openstack role add --project service --user glance admin
#openstack service create --name glance --description "OpenStack Image" image
#openstack endpoint create --region RegionOne image public http://controller0:9292
#openstack endpoint create --region RegionOne image internal http://controller0:9292
#openstack endpoint create --region RegionOne image admin http://controller0:9292
#
#
#- name: "{{ ansible_distribution }}: install glance"
#  yum:
#    name: openstack-glance
#
#- name: "{{ ansible_distribution }}: glance-api.conf"
#  file:
#    dest: /etc/glance/glance-api.conf
#
#- name: "{{ ansible_distribution }}: glance-registry.conf"
#  file:
#    dest: /etc/glance/glance-registry.conf
#
#- name: "{{ ansible_distribution }}: populate the glance database"
#  shell: source /tmp/admin-rc && su -s /bin/sh -c "glance-manage db_sync" glance
#
#- name: "{{ ansible_distribution }}: start and enable the glance services"
#  service:
#    enabled: yes
#    name: "{{ item }}"
#    state: started
#  with_items:
#    - openstack-glance-api.service
#    - openstack-glance-registry.service
