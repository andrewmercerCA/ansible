---

- name: "{{ansible_distribution}}: install epel-release"
  yum:
    name: epel-release
  when:
    - ansible_os_family == 'RedHat'
    - ansible_distribution != 'Fedora'

- name: "{{ansible_distribution}}: install epel-release"
  dnf:
    name: epel-release
  when: ansible_distribution == 'Fedora'

- name: "{{ ansible_distribution }}: install base packages"
  yum:
    name: "{{base_packages}}"
  when:
    - ansible_os_family == 'RedHat'
    - ansible_distribution != 'Fedora'

- name: "{{ ansible_distribution }}: install base packages"
  dnf:
    name: "{{base_packages}}"
  when: ansible_distribution == 'Fedora'

- name: "{{ansible_distribution}}: install dnf-plugins-core"
  dnf:
    name: 
      - dnf-plugins-core
  when: ansible_distribution == 'Fedora'

- name: "{{ansible_distribution}}: Update all installed packages"
  yum: name=* state=latest
  when:
    - ansible_os_family == 'RedHat'
    - ansible_distribution != 'Fedora'

- name: "{{ansible_distribution}}: Update all installed packages"
  dnf: name=* state=latest
  when: ansible_distribution == 'Fedora'

- name: "{{ansible_distribution}}: Set the timezone"
  timezone:
    name: "{{timezone}}"

- name: "{{ ansible_distribution }}: bash customizations"
  block:

    - name: "{{ansible_distribution}}: change bash PS1"
      copy:
        content: |
          #!/bin/bash
          [ "$PS1" = "\\s-\\v\\\$ " ] && PS1="[\u@\H \W]\\$ "
        dest: /etc/profile.d/ps.sh

    - name: "{{ ansible_distribution }}: custom bash aliases"
      copy:
        content: |
          alias cp_backup="cp -f --backup --suffix='.copy'"
          alias grep_whitespace="grep -v '^\s*$\|^\s*\#'"
        dest: /etc/profile.d/aliases.sh

    - name: "{{ ansible_distribution }}: configure paths"
      copy:
        content: |
          PATH=$PATH:$HOME/.local/bin:$HOME/bin:$HOME/bin_public:$HOME/bin_private
          export PATH
        dest: /etc/profile.d/paths.sh

    - name: "{{ ansible_distribution }}: configure HISTTIMEFORMAT"
      copy:
        content: |
          export HISTTIMEFORMAT="%Y-%m-%d %T "
        dest: /etc/profile.d/histtimeformat.sh

  when: ansible_os_family == 'RedHat'

- name: "{{ ansible_distribution }}: vim customizations"
  copy:
    content: |
      filetype indent off
      autocmd FileType yaml setlocal et ts=2 ai sw=2
    #dest: "/home/{{ ansible_env.SUDO_USER }}/.vimrc"
    dest: "/home/{{ user }}/.vimrc"

- name: "{{ ansible_distribution }}: add user to sudoers"
  copy:
    content: |
      "{{ user }}" ALL=(ALL) NOPASSWD: ALL
    dest: /etc/sudoers.d/00-{{ user }}

- name: "{{ ansible_distribution }}: install selinux packages"
  yum:
    name: "{{ selinux_packages }}"
  when:
    #- ansible_selinux is defined and ansible_selinux != False and ansible_selinux.status == 'enabled'
    - ansible_selinux.status == "enabled"
    - ansible_os_family == 'RedHat'
    - ansible_distribution != 'Fedora'

- name: "{{ansible_distribution}}: install selinux packages"
  dnf:
    name: "{{selinux_packages}}"
  when:
    #- ansible_selinux is defined and ansible_selinux != False and ansible_selinux.status == 'enabled'
    - ansible_selinux.status == "enabled"
    - ansible_distribution == 'Fedora'

